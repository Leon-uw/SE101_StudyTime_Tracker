<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics - Study Log Dashboard</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<body data-graded-scores='{{ stats.graded_scores|tojson }}'
    data-top-hours-subjects='{{ stats.top_hours_subjects|tojson }}'
    data-efficient-subjects='{{ stats.efficient_subjects|tojson }}' data-strong='{{ stats.strong_scores|tojson }}'
    data-needs='{{ stats.needs_work|tojson }}' data-assignment-count='{{ stats.overall.assignment_count }}'
    data-all-grades='{{ stats.all_grades|tojson }}' data-all-logs='{{ stats.all_study_logs|tojson }}'>

    <!-- Sidebar (hidden - using top nav) -->
    <div id="sidebar" class="sidebar">
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>

    <!-- Main Content -->
    <div class="main-wrapper">
        <!-- Top Navigation Bar -->
        <header class="top-nav">
            <div class="nav-left">
                <a href="{{ url_for('display_table') }}" class="logo-link">
                    <img src="{{ url_for('static', filename='images/snowmark-logo.png') }}" alt="Snowmark Logo"
                        class="logo-img">
                    <span class="logo-text">Snowmark</span>
                </a>
            </div>
            <div class="nav-center">
                <h1>{{ page_title }}</h1>
            </div>
            <div class="nav-right">
                <span class="user-greeting">{{ current_user.username }}</span>
            </div>
        </header>

        <!-- Secondary Navigation Bar -->
        <nav class="secondary-nav">
            <div class="nav-links">
                <a href="{{ url_for('display_table') }}" class="nav-link">Dashboard</a>

                <div class="nav-dropdown">
                    <button class="nav-link dropdown-toggle">
                        Subjects <span class="arrow">▼</span>
                    </button>
                    <div class="dropdown-menu">
                        {% for subject in subjects %}
                        <a href="{{ url_for('display_subject', subject_name=subject) }}" class="dropdown-item">{{
                            subject }}</a>
                        {% endfor %}
                        <div class="dropdown-divider"></div>
                        <a href="#" id="add-subject-link" class="dropdown-item add-subject-item">+ Add Subject</a>
                    </div>
                </div>

                {% if retired_subjects %}
                <div class="nav-dropdown">
                    <button class="nav-link dropdown-toggle">
                        Retired <span class="arrow">▼</span>
                    </button>
                    <div class="dropdown-menu">
                        {% for subject in retired_subjects %}
                        <a href="{{ url_for('display_subject', subject_name=subject) }}" class="dropdown-item">{{
                            subject }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <a href="{{ url_for('stats') }}" class="nav-link active">Stats</a>
                <a href="{{ url_for('about') }}" class="nav-link">About</a>
            </div>
            <div class="nav-actions">
                <label class="switch icon-switch scheme-switch nav-switch" title="Toggle Color Scheme (Frosty/Toasty)">
                    <input type="checkbox" id="scheme-toggle">
                    <span class="slider"></span>
                </label>
                <label class="switch icon-switch theme-switch nav-switch" title="Toggle Dark Mode">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
                <a href="{{ url_for('logout') }}" class="nav-link logout-link">Log Out</a>
            </div>
        </nav>

        <div class="content-container">
            <div class="main-container">
                <div class="full-width-panel stats-panel">
                    <div class="stats-header animate-enter">
                        <div>
                            <h2>Statistics</h2>
                            <p class="stats-lede">A quick pulse on how your studying is going, what is working, and where
                                to
                                focus next.</p>
                        </div>
                        <div class="stats-tag">Live from your study log</div>
                    </div>
                    <div class="stats-toggle-row">
                        <span class="muted">Display grades as</span>
                        <div class="toggle-group">
                            <button class="toggle-btn active" data-stats-toggle="percent">Percent</button>
                            <button class="toggle-btn" data-stats-toggle="gpa">GPA (4.0)</button>
                        </div>
                    </div>


                    {% if not stats.has_data %}
                    <div class="empty-state">
                        <h3>No data yet</h3>
                        <p>Add a subject and log a few assessments or predictions to see your stats here.</p>
                    </div>
                    {% else %}
                    <div class="stats-metrics-grid animate-enter delay-1">
                        <div class="stats-card metric-card">
                            <p class="label">Overall GPA</p>
                            <div class="metric-value">
                                {% if stats.overall.gpa is not none %}
                                <span class="stat-grade" data-grade-percent="{{ stats.overall.gpa }}">{{
                                    "%.1f"|format(stats.overall.gpa) }}%</span>
                                {% else %}N/A{% endif %}
                            </div>
                            <p class="stat-subtext">Weighted across graded work</p>
                        </div>
                        <div class="stats-card metric-card">
                            <p class="label">Total Study Hours</p>
                            <div class="metric-value">{{ "%.1f"|format(stats.overall.total_hours) }}h</div>
                            <p class="stat-subtext">{{ stats.overall.assignment_count }} logged assessments</p>
                        </div>
                        <div class="stats-card metric-card">
                            <p class="label">Grade / Hour</p>
                            <div class="metric-value">
                                {% if stats.overall.grade_per_hour is not none %}
                                <span class="stat-grade-per-hour"
                                    data-grade-per-hour="{{ stats.overall.grade_per_hour }}">{{
                                    "%.2f"|format(stats.overall.grade_per_hour) }}%/h</span>
                                {% else %}N/A{% endif %}
                            </div>
                            <p class="stat-subtext">Ratio of total average grade to time studied</p>
                        </div>
                        <div class="stats-card metric-card">
                            <p class="label">Predictions Run</p>
                            <div class="metric-value">{{ stats.predictions.total }}</div>
                            {% if stats.predictions.top_subject %}
                            <p class="stat-subtext">Most predicted: {{ stats.predictions.top_subject.subject }} ({{
                                stats.predictions.top_subject.count }})</p>
                            {% else %}
                            <p class="stat-subtext">No predictions yet</p>
                            {% endif %}
                        </div>
                        <div class="stats-card metric-card">
                            <p class="label">Prediction Accuracy</p>
                            <div class="metric-value">
                                {% if stats.prediction_accuracy.accuracy is not none %}
                                {{ "%.1f"|format(stats.prediction_accuracy.accuracy) }}%
                                {% else %}N/A{% endif %}
                            </div>
                            {% if stats.prediction_accuracy.mean_abs_error is not none %}
                            <p class="stat-subtext">Avg error: {{
                                "%.1f"|format(stats.prediction_accuracy.mean_abs_error) }} pts across {{
                                stats.prediction_accuracy.matched }} matched prediction{{ 's' if
                                stats.prediction_accuracy.matched != 1 else '' }}.</p>
                            {% else %}
                            <p class="stat-subtext">Log actual grades for predicted items to track accuracy.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="stats-grid animate-enter delay-2">
                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Most Studied</h3>
                                <span class="pill">Top 3 by hours</span>
                            </div>
                            {% if stats.top_hours_subjects %}
                            <ul class="stat-list">
                                {% for item in stats.top_hours_subjects %}
                                <li>
                                    <div class="stat-list-main">
                                        <strong>{{ item.subject }}</strong>
                                        {% if item.average_grade is not none %}
                                        <div class="muted">Avg <span class="stat-grade"
                                                data-grade-percent="{{ item.average_grade }}">{{
                                                "%.1f"|format(item.average_grade) }}%</span></div>
                                        {% endif %}
                                    </div>
                                    <div class="stat-list-meta">
                                        <span class="highlight">{{ "%.1f"|format(item.hours) }}h</span>
                                        <span class="muted mini">time logged</span>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="muted">No study time logged yet.</p>
                            {% endif %}
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Efficiency Leaders</h3>
                                <span class="pill">High grade, low time</span>
                            </div>
                            {% if stats.efficient_subjects %}
                            <ul class="stat-list">
                                {% for item in stats.efficient_subjects %}
                                <li>
                                    <div class="stat-list-main">
                                        <strong>{{ item.subject }}</strong>
                                        <div class="muted"><span class="stat-grade"
                                                data-grade-percent="{{ item.average_grade }}">{{
                                                "%.1f"|format(item.average_grade) }}%</span> average</div>
                                    </div>
                                    <span class="highlight stat-grade-per-hour"
                                        data-grade-per-hour="{{ item.efficiency }}">{{ "%.2f"|format(item.efficiency)
                                        }}%/h</span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="muted">Log grades and hours to see efficiency insights.</p>
                            {% endif %}
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Category Standout</h3>
                                <span class="pill">Best performance</span>
                            </div>
                            {% if stats.best_category %}
                            <p><strong>{{ stats.best_category.category }}</strong> in {{ stats.best_category.subject }}
                            </p>
                            <p class="big-number stat-grade" data-grade-percent="{{ stats.best_category.average }}">{{
                                "%.1f"|format(stats.best_category.average) }}%</p>
                            <p class="muted">{{ stats.best_category.samples }} graded item(s)</p>
                            {% else %}
                            <p class="muted">Keep logging grades to surface your strongest category.</p>
                            {% endif %}
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Focus Suggestion</h3>
                                <span class="pill danger">Needs attention</span>
                            </div>
                            {% if stats.focus_subject %}
                            <p><strong>{{ stats.focus_subject.subject }}</strong></p>
                            <p class="big-number danger-text stat-grade"
                                data-grade-percent="{{ stats.focus_subject.average }}">{{
                                "%.1f"|format(stats.focus_subject.average) }}%</p>
                            <p class="muted">{{ "%.1f"|format(stats.focus_subject.hours) }}h across {{
                                stats.focus_subject.assignments }} assessment(s)</p>
                            <p class="hint">Spend a bit more time here to lift your average.</p>
                            {% else %}
                            <p class="muted">No graded subjects yet — add a grade to get guidance.</p>
                            {% endif %}
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>High Scores</h3>
                                <span id="high-pill-text" class="pill" data-toggle-percent-label="90%+ results"
                                    data-toggle-gpa-label="3.6+ GPA results">90%+ results</span>
                            </div>
                            <div class="threshold-controls inline">
                                <div class="threshold-group">
                                    <label for="high-threshold">Threshold ≥</label>
                                    <input type="number" id="high-threshold" min="0" max="100" step="1" value="90">
                                    <span class="muted mini" id="high-threshold-hint">(90% / 3.60 GPA)</span>
                                </div>
                            </div>
                            <p class="big-number" id="high-score-pct-display">
                                {% if stats.strong_scores.pct is not none %}{{ "%.1f"|format(stats.strong_scores.pct)
                                }}%{% else %}N/A{% endif %}
                            </p>
                            <p class="muted" id="high-score-desc">
                                {% if stats.strong_scores.pct is not none %}
                                {{ stats.strong_scores.count }} of {{ stats.overall.assignment_count }} graded items
                                cleared the high-score bar.
                                {% else %}
                                Add more graded items to see this metric.
                                {% endif %}
                            </p>
                            <p class="hint">Snapshot of how often you’re excelling.</p>
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Needs Work</h3>
                                <span id="low-pill-text" class="pill danger">Below 70%</span>
                            </div>
                            <div class="threshold-controls inline">
                                <div class="threshold-group">
                                    <label for="low-threshold">Threshold &lt;</label>
                                    <input type="number" id="low-threshold" min="0" max="100" step="1" value="70">
                                    <span class="muted mini" id="low-threshold-hint">(70% / 2.80 GPA)</span>
                                </div>
                            </div>
                            <p class="big-number danger-text" id="needs-work-pct-display">
                                {% if stats.needs_work.pct is not none %}{{ "%.1f"|format(stats.needs_work.pct) }}%{%
                                else %}N/A{% endif %}
                            </p>
                            <p class="muted" id="needs-work-desc">
                                {% if stats.needs_work.pct is not none %}
                                {{ stats.needs_work.count }} of {{ stats.overall.assignment_count }} graded items are
                                under the target range.
                                {% else %}
                                Add more graded items to see this metric.
                                {% endif %}
                            </p>
                            <p class="hint">Use this list to pick where to invest more study time.</p>
                        </div>

                        <!-- Grade Distribution -->
                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Grade Distribution</h3>
                                <select id="gradesSelect" class="subject-filter mini">
                                    <option value="ALL">All subjects</option>
                                    {% for s in subjects %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="chart-wrap" style="height: 240px;">
                                <canvas id="gradesHistogram"></canvas>
                            </div>
                        </div>


                        <!-- Top Subjects by Hours -->
                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Top Subjects by Hours</h3>
                            </div>
                            <div class="chart-wrap" style="height: 240px;">
                                <canvas id="topHoursBar" height="140"></canvas>
                            </div>
                        </div>

                        <!-- Efficiency by Subject -->
                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Efficiency by Subject</h3>
                            </div>
                            <div class="chart-wrap" style="height: 240px;">
                                <canvas id="efficiencyBar" height="140"></canvas>
                            </div>
                        </div>

                        <!-- Score Outcomes -->
                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Score Outcomes</h3>
                                <select id="outcomesSelect" class="subject-filter mini">
                                    <option value="ALL">All subjects</option>
                                    {% for s in subjects %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="chart-wrap" style="height: 240px;">
                                <canvas id="outcomesPie"></canvas>
                            </div>
                        </div>



                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div id="add-subject-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0;">Add New Subject</h3>
            <input type="text" id="new-subject-input" placeholder="Enter subject name..."
                style="width: 100%; padding: 10px; margin-bottom: 1em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
            <div class="modal-buttons">
                <button id="subject-modal-confirm">Add Subject</button>
                <button id="subject-modal-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>

    <script>
        (function () {
            const el = document.body.dataset;

            // ---- data (already computed server-side) ----
            const gradedAgg = JSON.parse(el.gradedScores || "[]");      // [numbers]
            const topHoursAgg = JSON.parse(el.topHoursSubjects || "[]");  // [{subject, hours}]
            const effAgg = JSON.parse(el.efficientSubjects || "[]"); // [{subject, efficiency, average_grade}]
            const strong = JSON.parse(el.strong || "{}");
            const needs = JSON.parse(el.needs || "{}");
            const totalAssignments = Number(el.assignmentCount || 0);

            // Optional raw rows if you added them earlier (fallbacks handle absence)
            const allGrades = JSON.parse(el.allGrades || "[]");           // [{subject, score}]
            const allLogs = JSON.parse(el.allLogs || "[]");             // [{subject, hours}]

            // ---- helpers ----
            const $ = (s) => document.querySelector(s);

            const LS_KEYS = {
                grades: 'stats.sel.grades',
                hours: 'stats.sel.hours',
                eff: 'stats.sel.eff',
                outcomes: 'stats.sel.outcomes',
            };
            const selects = {
                grades: $('#gradesSelect'),
                hours: $('#hoursSelect'),
                eff: $('#effSelect'),
                outcomes: $('#outcomesSelect'),
            };
            function loadSel(key) { return localStorage.getItem(key) || 'ALL'; }
            function saveSel(key, v) { localStorage.setItem(key, v); }

            function toDeciles(xs) {
                const bins = new Array(10).fill(0);
                xs.forEach(v => {
                    const x = Number(v);
                    if (!isFinite(x)) return;
                    const idx = Math.min(9, Math.max(0, Math.floor(x / 10)));
                    bins[idx] += 1;
                });
                return bins;
            }
            function hoursBySubject(logs) {
                const map = new Map();
                logs.forEach(l => map.set(l.subject, (map.get(l.subject) || 0) + Number(l.hours || 0)));
                return Array.from(map, ([subject, hours]) => ({ subject, hours }));
            }
            function efficiencyFromRaw(grades, logs) {
                const sum = new Map(), cnt = new Map(), hrs = new Map();
                grades.forEach(g => {
                    sum.set(g.subject, (sum.get(g.subject) || 0) + Number(g.score || 0));
                    cnt.set(g.subject, (cnt.get(g.subject) || 0) + 1);
                });
                logs.forEach(l => hrs.set(l.subject, (hrs.get(l.subject) || 0) + Number(l.hours || 0)));
                return Array.from(new Set([...sum.keys(), ...hrs.keys()])).map(s => {
                    const avg = (sum.get(s) || 0) / Math.max(1, (cnt.get(s) || 0));
                    const h = hrs.get(s) || 0;
                    return { subject: s, efficiency: h ? avg / h : 0 };
                });
            }

            // ---- Chart instances ----
            let chartGrades, chartHours, chartEff, chartOut;

            // common chart options (dark theme friendly)
            const baseOpts = {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 800, easing: 'easeOutCubic' },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } },
                    x: { ticks: { autoSkip: false } }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, font: { weight: '600' } },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => (ctx.dataset.label ? `${ctx.dataset.label}: ${ctx.parsed.y ?? ctx.parsed}` : `${ctx.parsed}`)
                        }
                    }
                }
            };

            function renderGrades(sel) {
                const labels = ["0–10", "10–20", "20–30", "30–40", "40–50", "50–60", "60–70", "70–80", "80–90", "90–100"];
                const data = allGrades.length
                    ? (sel === 'ALL' ? allGrades : allGrades.filter(g => g.subject === sel)).map(g => g.score)
                    : gradedAgg;
                const bins = toDeciles(data);

                chartGrades?.destroy();
                const barColor = getComputedStyle(document.body).getPropertyValue('--primary-color').trim();
                chartGrades = new Chart($('#gradesHistogram'), {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Count', data: bins, borderRadius: 6, backgroundColor: barColor }] },
                    options: { ...baseOpts, plugins: { ...baseOpts.plugins, title: { ...baseOpts.plugins.title, text: `Grade Distribution (${sel === 'ALL' ? 'All subjects' : sel})` } } }
                });
            }

            function renderHours(sel) {
                let labels, values;
                if (allLogs.length) {
                    const rows = sel === 'ALL' ? allLogs : allLogs.filter(l => l.subject === sel);
                    const agg = hoursBySubject(rows).sort((a, b) => b.hours - a.hours);
                    labels = agg.map(x => x.subject); values = agg.map(x => x.hours);
                } else {
                    labels = topHoursAgg.map(x => x.subject); values = topHoursAgg.map(x => Number(x.hours || 0));
                }

                chartHours?.destroy();
                const barColor = getComputedStyle(document.body).getPropertyValue('--primary-color').trim();
                chartHours = new Chart($('#topHoursBar'), {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Hours', data: values, borderRadius: 6, barPercentage: 0.65, categoryPercentage: 0.6, backgroundColor: barColor }] },
                    options: { ...baseOpts, plugins: { ...baseOpts.plugins, title: { ...baseOpts.plugins.title, text: `Study Time by Subject (${sel === 'ALL' ? 'All subjects' : sel})` } } }
                });
            }

            function renderEfficiency(sel) {
                let labels, values;
                if (allGrades.length && allLogs.length) {
                    const g = sel === 'ALL' ? allGrades : allGrades.filter(x => x.subject === sel);
                    const l = sel === 'ALL' ? allLogs : allLogs.filter(x => x.subject === sel);
                    const arr = efficiencyFromRaw(g, l).sort((a, b) => b.efficiency - a.efficiency);
                    labels = arr.map(x => x.subject);
                    values = arr.map(x => Number(x.efficiency.toFixed(3)));
                } else {
                    labels = effAgg.map(x => x.subject);
                    values = effAgg.map(x => Number(x.efficiency || 0));
                }

                chartEff?.destroy();
                const barColor = getComputedStyle(document.body).getPropertyValue('--primary-color').trim();
                chartEff = new Chart($('#efficiencyBar'), {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Efficiency (%/h)', data: values, borderRadius: 6, barPercentage: 0.65, categoryPercentage: 0.6, backgroundColor: barColor }] },
                    options: { ...baseOpts, plugins: { ...baseOpts.plugins, title: { ...baseOpts.plugins.title, text: `Efficiency by Subject (${sel === 'ALL' ? 'All subjects' : sel})` } } }
                });
            }

            function getThresholds() {
                // Read current thresholds from the inputs on the page
                const hi = Math.max(0, Math.min(100, Number(document.getElementById('high-threshold')?.value ?? 90)));
                const lo = Math.max(0, Math.min(100, Number(document.getElementById('low-threshold')?.value ?? 70)));
                return { high: hi, low: lo };
            }

            function renderOutcomes(sel) {
                // Need per-subject scores -> prefer raw grades list
                // allGrades looks like: [{ subject, score }, ...]
                const { high, low } = getThresholds();

                // Get colors from CSS variables
                const styles = getComputedStyle(document.body);
                const strongColor = styles.getPropertyValue('--chart-strong').trim();
                const needsWorkColor = styles.getPropertyValue('--chart-needs-work').trim();
                const otherColor = styles.getPropertyValue('--chart-other').trim();

                let rows = allGrades.length ? allGrades : [];
                if (!rows.length) {
                    // Fallback to aggregate (no subject filter possible)
                    const strongCount = Number(strong.count || 0);
                    const needsCount = Number(needs.count || 0);
                    const otherCount = Math.max(0, totalAssignments - strongCount - needsCount);
                    const borderColor = styles.getPropertyValue('--chart-border').trim();

                    chartOut?.destroy();
                    chartOut = new Chart(document.getElementById('outcomesPie'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Strong', 'Needs Work', 'Other'],
                            datasets: [{
                                data: [strongCount, needsCount, otherCount],
                                backgroundColor: [strongColor, needsWorkColor, otherColor],
                                borderColor: borderColor,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Score Outcomes (All subjects)' } }
                        }
                    });
                    return;
                }

                // Filter by subject if not "ALL"
                if (sel !== 'ALL') rows = rows.filter(r => r.subject === sel);

                // Count using current thresholds
                let strongCount = 0, needsCount = 0, otherCount = 0;
                for (const r of rows) {
                    const g = Number(r.score);
                    if (!isFinite(g)) continue;
                    if (g >= high) strongCount++;
                    else if (g < low) needsCount++;
                    else otherCount++;
                }

                const borderColor = styles.getPropertyValue('--chart-border').trim();

                chartOut?.destroy();
                chartOut = new Chart(document.getElementById('outcomesPie'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Strong', 'Needs Work', 'Other'],
                        datasets: [{
                            data: [strongCount, needsCount, otherCount],
                            backgroundColor: [strongColor, needsWorkColor, otherColor],
                            borderColor: borderColor,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: `Score Outcomes (${sel === 'ALL' ? 'All subjects' : sel})` }
                        }
                    }
                });
            }

            // ---- wire up selects with persistence ----
            function initSelect(selEl, key, renderFn) {
                if (!selEl) return;
                const saved = loadSel(key);
                selEl.value = saved;
                renderFn(saved);
                selEl.addEventListener('change', e => { saveSel(key, e.target.value); renderFn(e.target.value); });
            }

            // Keep filters only for Grades and Outcomes
            // Delay initial rendering to ensure dark mode class is applied first
            requestAnimationFrame(() => {
                initSelect(selects.grades, LS_KEYS.grades, renderGrades);
                initSelect(selects.outcomes, LS_KEYS.outcomes, renderOutcomes);

                // Always show all-subject data for Hours and Efficiency
                renderHours('ALL');
                renderEfficiency('ALL');
            });

            // (optional cleanup: clear old saved filter values)
            localStorage.removeItem(LS_KEYS.hours);
            localStorage.removeItem(LS_KEYS.eff);

            // Re-render Outcomes when thresholds change
            const hiInput = document.getElementById('high-threshold');
            const loInput = document.getElementById('low-threshold');
            const outcomesSelEl = document.getElementById('outcomesSelect');

            // Function to update all threshold-dependent displays
            function updateAllThresholdDisplays() {
                const { high, low } = getThresholds();
                
                // Recalculate High Scores card
                let highCount = 0;
                for (const r of allGrades) {
                    const g = Number(r.score);
                    if (isFinite(g) && g >= high) highCount++;
                }
                const highPct = totalAssignments > 0 ? (highCount / totalAssignments * 100) : null;
                const highPctEl = document.getElementById('high-score-pct-display');
                const highDescEl = document.getElementById('high-score-desc');
                const highPillEl = document.getElementById('high-pill-text');
                const highHintEl = document.getElementById('high-threshold-hint');
                
                if (highPctEl) {
                    highPctEl.textContent = highPct !== null ? `${highPct.toFixed(1)}%` : 'N/A';
                }
                if (highDescEl && highPct !== null) {
                    highDescEl.textContent = `${highCount} of ${totalAssignments} graded items cleared the high-score bar.`;
                }
                if (highPillEl) {
                    highPillEl.textContent = `${high}%+ results`;
                }
                if (highHintEl) {
                    highHintEl.textContent = `(${high}% / ${(high / 25).toFixed(2)} GPA)`;
                }
                
                // Recalculate Needs Work card
                let lowCount = 0;
                for (const r of allGrades) {
                    const g = Number(r.score);
                    if (isFinite(g) && g < low) lowCount++;
                }
                const lowPct = totalAssignments > 0 ? (lowCount / totalAssignments * 100) : null;
                const lowPctEl = document.getElementById('needs-work-pct-display');
                const lowDescEl = document.getElementById('needs-work-desc');
                const lowPillEl = document.getElementById('low-pill-text');
                const lowHintEl = document.getElementById('low-threshold-hint');
                
                if (lowPctEl) {
                    lowPctEl.textContent = lowPct !== null ? `${lowPct.toFixed(1)}%` : 'N/A';
                }
                if (lowDescEl && lowPct !== null) {
                    lowDescEl.textContent = `${lowCount} of ${totalAssignments} graded items are under the target range.`;
                }
                if (lowPillEl) {
                    lowPillEl.textContent = `Below ${low}%`;
                }
                if (lowHintEl) {
                    lowHintEl.textContent = `(${low}% / ${(low / 25).toFixed(2)} GPA)`;
                }
                
                // Re-render the outcomes pie chart
                const sel = outcomesSelEl ? outcomesSelEl.value : 'ALL';
                renderOutcomes(sel);
            }

            // Attach input listeners for automatic threshold updates
            hiInput?.addEventListener('input', updateAllThresholdDisplays);
            loInput?.addEventListener('input', updateAllThresholdDisplays);

            // Re-render charts when theme changes
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('change', () => {
                    // Wait for dark mode class to be applied/removed before re-rendering
                    setTimeout(() => {
                        // Re-render all charts with new theme colors
                        const gradesSelVal = selects.grades ? selects.grades.value : 'ALL';
                        const outcomesSelVal = selects.outcomes ? selects.outcomes.value : 'ALL';

                        renderGrades(gradesSelVal);
                        renderHours('ALL');
                        renderEfficiency('ALL');
                        renderOutcomes(outcomesSelVal);
                    }, 50); // Small delay to let DOM update
                });
            }

            // Re-render charts when color scheme changes
            const schemeToggle = document.getElementById('scheme-toggle');
            if (schemeToggle) {
                schemeToggle.addEventListener('change', () => {
                    setTimeout(() => {
                        const gradesSelVal = selects.grades ? selects.grades.value : 'ALL';
                        const outcomesSelVal = selects.outcomes ? selects.outcomes.value : 'ALL';

                        renderGrades(gradesSelVal);
                        renderHours('ALL');
                        renderEfficiency('ALL');
                        renderOutcomes(outcomesSelVal);
                    }, 50);
                });
            }

            // Animated counter effect for metric values
            function animateCounter(element, target, suffix = '', decimals = 0) {
                const duration = 1200;
                const startTime = performance.now();
                const startValue = 0;
                
                function update(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function for smooth deceleration
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const currentValue = startValue + (target - startValue) * easeOut;
                    
                    element.textContent = currentValue.toFixed(decimals) + suffix;
                    
                    if (progress < 1) {
                        requestAnimationFrame(update);
                    }
                }
                
                requestAnimationFrame(update);
            }

            // Animate all metric values on page load
            function initCounterAnimations() {
                // Find all metric values and animate them
                document.querySelectorAll('.metric-value').forEach(el => {
                    const gradeSpan = el.querySelector('.stat-grade');
                    const gradePerHourSpan = el.querySelector('.stat-grade-per-hour');
                    
                    if (gradeSpan) {
                        const value = parseFloat(gradeSpan.dataset.gradePercent);
                        if (!isNaN(value)) {
                            animateCounter(gradeSpan, value, '%', 1);
                        }
                    } else if (gradePerHourSpan) {
                        const value = parseFloat(gradePerHourSpan.dataset.gradePerHour);
                        if (!isNaN(value)) {
                            animateCounter(gradePerHourSpan, value, '%/h', 2);
                        }
                    } else {
                        // Handle plain text metric values (like hours or prediction count)
                        const text = el.textContent.trim();
                        const hourMatch = text.match(/^([\d.]+)h$/);
                        const numberMatch = text.match(/^(\d+)$/);
                        const percentMatch = text.match(/^([\d.]+)%$/);
                        
                        if (hourMatch) {
                            const value = parseFloat(hourMatch[1]);
                            animateCounter(el, value, 'h', 1);
                        } else if (percentMatch) {
                            const value = parseFloat(percentMatch[1]);
                            animateCounter(el, value, '%', 1);
                        } else if (numberMatch) {
                            const value = parseInt(numberMatch[1]);
                            animateCounter(el, value, '', 0);
                        }
                    }
                });
            }

            // Start counter animations after a short delay for page load
            setTimeout(initCounterAnimations, 300);
        })();
    </script>



</body>

</html>