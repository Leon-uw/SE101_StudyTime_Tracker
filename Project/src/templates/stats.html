<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics - Study Log Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<body data-graded-scores='{{ stats.graded_scores|tojson }}'
    data-top-hours-subjects='{{ stats.top_hours_subjects|tojson }}'
    data-efficient-subjects='{{ stats.efficient_subjects|tojson }}'
    data-strong='{{ stats.strong_scores|tojson }}'
    data-needs='{{ stats.needs_work|tojson }}'
    data-assignment-count='{{ stats.overall.assignment_count }}'>
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>Menu</h3>
            <button id="close-sidebar-btn" class="close-btn">&times;</button>
        </div>
        <ul class="sidebar-menu">
            <li><a href="{{ url_for('display_table') }}">Home</a></li>
            <li class="has-submenu">
                <a href="#" id="subjects-toggle">Subjects <span class="arrow">&#9662;</span></a>
                <ul class="submenu" id="subjects-submenu">
                    {% for subject in subjects %}
                    <li><a href="{{ url_for('display_subject', subject_name=subject) }}">{{ subject }}</a></li>
                    {% endfor %}
                    <li><a href="#" id="add-subject-link" class="add-subject-link">+ Add Subject</a></li>
                </ul>
            </li>
            <li><a href="{{ url_for('about') }}">About</a></li>
            <li><a href="{{ url_for('stats') }}">Stats</a></li>
            <li class="theme-toggle-item">
                <span>Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
            </li>
            <li><a href="{{ url_for('logout') }}">Log Out</a></li>
        </ul>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>

    <!-- Main Content -->
    <div class="main-wrapper">
        <!-- Top Navigation Bar -->
        <header class="top-nav">
            <div class="nav-left">
                <button id="menu-btn" class="menu-btn">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </button>
            </div>
            <div class="nav-center">
                <h1>{{ page_title }}</h1>
            </div>
            <div class="nav-right">
                <a href="{{ url_for('display_table') }}" class="logo-link">
                    <div class="logo-placeholder">Logo</div>
                </a>
            </div>
        </header>

        <div class="content-container">
            <div class="main-container">
                <div class="full-width-panel stats-panel">
                    <div class="stats-header">
                        <div>
                            <h2>Statistics</h2>
                            <p class="stats-lede">Quick pulse on how your studying is going, what is working, and where to
                                focus next.</p>
                        </div>
                        <div class="stats-tag">Live from your study log</div>
                    </div>
                    <div class="stats-toggle-row">
                        <span class="muted">Display grades as</span>
                        <div class="toggle-group">
                            <button class="toggle-btn active" data-stats-toggle="percent">Percent</button>
                            <button class="toggle-btn" data-stats-toggle="gpa">GPA (4.0)</button>
                        </div>
                    </div>

                    {% if not stats.has_data %}
                    <div class="empty-state">
                        <h3>No data yet</h3>
                        <p>Add a subject and log a few assignments or predictions to see your stats here.</p>
                    </div>
                    {% else %}
                    <div class="stats-metrics-grid">
                        <div class="stats-card metric-card">
                            <p class="label">Overall GPA</p>
                            <div class="metric-value">
                                {% if stats.overall.gpa is not none %}
                                <span class="stat-grade" data-grade-percent="{{ stats.overall.gpa }}">{{ "%.1f"|format(stats.overall.gpa) }}%</span>
                                {% else %}N/A{% endif %}
                            </div>
                            <p class="stat-subtext">Weighted across graded work</p>
                        </div>
                        <div class="stats-card metric-card">
                            <p class="label">Total Study Hours</p>
                            <div class="metric-value">{{ "%.1f"|format(stats.overall.total_hours) }}h</div>
                            <p class="stat-subtext">{{ stats.overall.assignment_count }} logged assignments</p>
                        </div>
                        <div class="stats-card metric-card">
                            <p class="label">Grade / Hour</p>
                            <div class="metric-value">
                                {% if stats.overall.grade_per_hour is not none %}
                                <span class="stat-grade-per-hour" data-grade-per-hour="{{ stats.overall.grade_per_hour }}">{{ "%.2f"|format(stats.overall.grade_per_hour) }}%/h</span>
                                {% else %}N/A{% endif %}
                            </div>
                            <p class="stat-subtext">Ratio of total average grade to time studied</p>
                        </div>
                        <div class="stats-card metric-card">
                            <p class="label">Predictions Run</p>
                            <div class="metric-value">{{ stats.predictions.total }}</div>
                            {% if stats.predictions.top_subject %}
                            <p class="stat-subtext">Most predicted: {{ stats.predictions.top_subject.subject }} ({{ stats.predictions.top_subject.count }})</p>
                            {% else %}
                            <p class="stat-subtext">No predictions yet</p>
                            {% endif %}
                        </div>
                        <div class="stats-card metric-card">
                            <p class="label">Prediction Accuracy</p>
                            <div class="metric-value">
                                {% if stats.prediction_accuracy.accuracy is not none %}
                                {{ "%.1f"|format(stats.prediction_accuracy.accuracy) }}%
                                {% else %}N/A{% endif %}
                            </div>
                            {% if stats.prediction_accuracy.mean_abs_error is not none %}
                            <p class="stat-subtext">Avg error: {{ "%.1f"|format(stats.prediction_accuracy.mean_abs_error) }} pts across {{ stats.prediction_accuracy.matched }} matched prediction{{ 's' if stats.prediction_accuracy.matched != 1 else '' }}.</p>
                            {% else %}
                            <p class="stat-subtext">Log actual grades for predicted items to track accuracy.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Most Studied</h3>
                                <span class="pill">Top 3 by hours</span>
                            </div>
                            {% if stats.top_hours_subjects %}
                            <ul class="stat-list">
                                {% for item in stats.top_hours_subjects %}
                                <li>
                                    <div class="stat-list-main">
                                        <strong>{{ item.subject }}</strong>
                                        {% if item.average_grade is not none %}
                                        <div class="muted">Avg <span class="stat-grade" data-grade-percent="{{ item.average_grade }}">{{ "%.1f"|format(item.average_grade) }}%</span></div>
                                        {% endif %}
                                    </div>
                                    <div class="stat-list-meta">
        <span class="highlight">{{ "%.1f"|format(item.hours) }}h</span>
        <span class="muted mini">time logged</span>
    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="muted">No study time logged yet.</p>
                            {% endif %}
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Efficiency Leaders</h3>
                                <span class="pill">High grade, low time</span>
                            </div>
                            {% if stats.efficient_subjects %}
                            <ul class="stat-list">
                                {% for item in stats.efficient_subjects %}
                                <li>
                                    <div class="stat-list-main">
                                        <strong>{{ item.subject }}</strong>
                                        <div class="muted"><span class="stat-grade" data-grade-percent="{{ item.average_grade }}">{{ "%.1f"|format(item.average_grade) }}%</span> average</div>
                                    </div>
                                    <span class="highlight stat-grade-per-hour" data-grade-per-hour="{{ item.efficiency }}">{{ "%.2f"|format(item.efficiency) }}%/h</span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="muted">Log grades and hours to see efficiency insights.</p>
                            {% endif %}
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Category Standout</h3>
                                <span class="pill">Best performance</span>
                            </div>
                            {% if stats.best_category %}
                            <p><strong>{{ stats.best_category.category }}</strong> in {{ stats.best_category.subject }}</p>
                            <p class="big-number stat-grade" data-grade-percent="{{ stats.best_category.average }}">{{ "%.1f"|format(stats.best_category.average) }}%</p>
                            <p class="muted">{{ stats.best_category.samples }} graded item(s)</p>
                            {% else %}
                            <p class="muted">Keep logging grades to surface your strongest category.</p>
                            {% endif %}
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Focus Suggestion</h3>
                                <span class="pill danger">Needs attention</span>
                            </div>
                            {% if stats.focus_subject %}
                            <p><strong>{{ stats.focus_subject.subject }}</strong></p>
                            <p class="big-number danger-text stat-grade" data-grade-percent="{{ stats.focus_subject.average }}">{{ "%.1f"|format(stats.focus_subject.average) }}%</p>
                            <p class="muted">{{ "%.1f"|format(stats.focus_subject.hours) }}h across {{ stats.focus_subject.assignments }} assignment(s)</p>
                            <p class="hint">Spend a bit more time here to lift your average.</p>
                            {% else %}
                            <p class="muted">No graded subjects yet — add a grade to get guidance.</p>
                            {% endif %}
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>High Scores</h3>
                                <span id="high-pill-text" class="pill" data-toggle-percent-label="90%+ results" data-toggle-gpa-label="3.6+ GPA results">90%+ results</span>
                            </div>
                            <div class="threshold-controls inline">
                                <div class="threshold-group">
                                    <label for="high-threshold">Threshold ≥</label>
                                    <input type="number" id="high-threshold" min="0" max="100" step="1" value="90">
                                    <span class="muted mini" id="high-threshold-hint">(90% / 3.60 GPA)</span>
                                </div>
                            </div>
                            <p class="big-number" id="high-score-pct-display">
                                {% if stats.strong_scores.pct is not none %}{{ "%.1f"|format(stats.strong_scores.pct) }}%{% else %}N/A{% endif %}
                            </p>
                            <p class="muted" id="high-score-desc">
                                {% if stats.strong_scores.pct is not none %}
                                {{ stats.strong_scores.count }} of {{ stats.overall.assignment_count }} graded items cleared the high-score bar.
                                {% else %}
                                Add more graded items to see this metric.
                                {% endif %}
                            </p>
                            <p class="hint">Snapshot of how often you’re excelling.</p>
                        </div>

                        <div class="stats-card">
                            <div class="card-heading">
                                <h3>Needs Work</h3>
                                <span id="low-pill-text" class="pill danger">Below 70%</span>
                            </div>
                            <div class="threshold-controls inline">
                                <div class="threshold-group">
                                    <label for="low-threshold">Threshold &lt;</label>
                                    <input type="number" id="low-threshold" min="0" max="100" step="1" value="70">
                                    <span class="muted mini" id="low-threshold-hint">(70% / 2.80 GPA)</span>
                                </div>
                            </div>
                            <p class="big-number danger-text" id="needs-work-pct-display">
                                {% if stats.needs_work.pct is not none %}{{ "%.1f"|format(stats.needs_work.pct) }}%{% else %}N/A{% endif %}
                            </p>
                            <p class="muted" id="needs-work-desc">
                                {% if stats.needs_work.pct is not none %}
                                {{ stats.needs_work.count }} of {{ stats.overall.assignment_count }} graded items are under the target range.
                                {% else %}
                                Add more graded items to see this metric.
                                {% endif %}
                            </p>
                            <p class="hint">Use this list to pick where to invest more study time.</p>
                        </div>

                        <div class="stats-card">
                            <h3>Grade Distribution</h3>
                            <canvas id="gradesHistogram" height="140"></canvas>
                        </div>

                        <div class="stats-card">
                            <h3>Top Subjects by Hours</h3>
                            <canvas id="topHoursBar" height="140"></canvas>
                        </div>

                        <div class="stats-card">
                            <h3>Efficiency by Subject</h3>
                            <canvas id="efficiencyBar" height="140"></canvas>
                        </div>

                        <div class="stats-card">
                            <h3>Score Outcomes</h3>
                            <canvas id="outcomesPie" height="140"></canvas>
                        </div>


                    </div>
                    <div class="threshold-action-row">
                        <button id="apply-thresholds" class="pill-btn">Update thresholds</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div id="add-subject-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0;">Add New Subject</h3>
            <input type="text" id="new-subject-input" placeholder="Enter subject name..."
                style="width: 100%; padding: 10px; margin-bottom: 1em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
            <div class="modal-buttons">
                <button id="subject-modal-confirm">Add Subject</button>
                <button id="subject-modal-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>

    <script>
        (function () {
        const el = document.body.dataset;

        // ------------- Parse data from stats -------------
        const graded = JSON.parse(el.gradedScores || "[]");                       // [numbers]
        const topHours = JSON.parse(el.topHoursSubjects || "[]");                 // [{subject, hours}]
        const efficient = JSON.parse(el.efficientSubjects || "[]");               // [{subject, efficiency}]
        const strong = JSON.parse(el.strong || "{}");                             // {pct, count}
        const needs = JSON.parse(el.needs || "{}");                               // {pct, count}
        const totalAssignments = Number(el.assignmentCount || 0);

        // ------------- 1) Histogram of graded_scores (deciles) -------------
        function toDeciles(xs) {
            const bins = new Array(10).fill(0); // 0-10, 10-20, ..., 90-100
            xs.forEach(v => {
            const x = Number(v);
            if (!isFinite(x)) return;
            const idx = Math.min(9, Math.max(0, Math.floor(x / 10)));
            bins[idx] += 1;
            });
            return bins;
        }
        const deciles = toDeciles(graded);
        const labelsDeciles = ["0–10","10–20","20–30","30–40","40–50","50–60","60–70","70–80","80–90","90–100"];
        new Chart(document.getElementById('gradesHistogram'), {
            type: 'bar',
            data: { labels: labelsDeciles, datasets: [{ label: 'Count', data: deciles }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // ------------- 2) Top subjects by hours -------------
        const hoursLabels = topHours.map(x => x.subject ?? x.Subject ?? '—');
        const hoursData = topHours.map(x => Number(x.hours ?? 0));
        new Chart(document.getElementById('topHoursBar'), {
            type: 'bar',
            data: { labels: hoursLabels, datasets: [{ label: 'Hours', data: hoursData }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // ------------- 3) Efficiency by subject (grade per hour or similar) -------------
        const effLabels = efficient.map(x => x.subject ?? '—');
        const effData = efficient.map(x => Number(x.efficiency ?? 0));
        new Chart(document.getElementById('efficiencyBar'), {
            type: 'bar',
            data: { labels: effLabels, datasets: [{ label: 'Efficiency', data: effData }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });

        // ------------- 4) Outcomes pie (Strong vs Needs Work vs Other) -------------
        const strongCount = Number(strong.count ?? 0);
        const needsCount  = Number(needs.count ?? 0);
        const otherCount  = Math.max(0, totalAssignments - strongCount - needsCount);
        new Chart(document.getElementById('outcomesPie'), {
            type: 'doughnut',
            data: {
            labels: ['Strong', 'Needs Work', 'Other'],
            datasets: [{ data: [strongCount, needsCount, otherCount] }]
            },
            options: { responsive: true }
        });
        })();
        </script>


</body>

</html>
