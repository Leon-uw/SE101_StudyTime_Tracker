<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Log Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}?v={{ range(1, 10000) | random }}">
</head>

<body data-chart-labels='{{ chart_labels|safe }}' data-chart-values='{{ chart_values|safe }}'
    data-subject-categories='{{ subject_categories_map_json|safe }}'
    data-weight-categories='{{ weight_categories_json|safe }}'>

    <!-- Sidebar (hidden - using top nav) -->
    <div id="sidebar" class="sidebar">
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>

    <!-- Main Content -->
    <div class="main-wrapper{% if is_dashboard %} dashboard-view{% endif %}">
        <!-- Top Navigation Bar -->
        <header class="top-nav">
            <div class="nav-left">
                <a href="{{ url_for('display_table') }}" class="logo-link">
                    <img src="{{ url_for('static', filename='images/snowmark-logo.png') }}" alt="Snowmark Logo"
                        class="logo-img">
                    <span class="logo-text">Snowmark</span>
                </a>
            </div>
            <div class="nav-center">
                <h1>{{ page_title }}
                    {% if is_retired_subject %}
                    <span
                        style="font-size: 0.6em; background-color: var(--text-secondary); color: white; padding: 2px 8px; border-radius: 4px; margin-left: 10px; vertical-align: middle;">RETIRED</span>
                    {% endif %}
                    {% if selected_subject and selected_subject != 'all' %}
                    <button id="rename-subject-btn" class="icon-btn" title="Rename Subject"
                        style="background: none; border: none; cursor: pointer; color: var(--text-color); margin-left: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    {% endif %}
                </h1>
            </div>
            <div class="nav-right">
                <span class="user-greeting">{{ current_user.username }}</span>
            </div>
        </header>

        <!-- Secondary Navigation Bar -->
        <nav class="secondary-nav">
            <div class="nav-links">
                <a href="{{ url_for('display_table') }}"
                    class="nav-link {% if is_dashboard %}active{% endif %}">Dashboard</a>

                <div class="nav-dropdown">
                    <button
                        class="nav-link dropdown-toggle {% if selected_subject and selected_subject != 'all' %}active{% endif %}">
                        {% if selected_subject and selected_subject != 'all' %}
                        {{ selected_subject }} <span class="arrow">▼</span>
                        {% else %}
                        Subjects <span class="arrow">▼</span>
                        {% endif %}
                    </button>
                    <div class="dropdown-menu">
                        {% for subject in subjects %}
                        <a href="{{ url_for('display_subject', subject_name=subject) }}" class="dropdown-item">{{
                            subject }}</a>
                        {% endfor %}
                        <div class="dropdown-divider"></div>
                        <a href="#" id="add-subject-link" class="dropdown-item add-subject-item">+ Add Subject</a>
                    </div>
                </div>

                {% if retired_subjects %}
                <div class="nav-dropdown">
                    <button class="nav-link dropdown-toggle">
                        Retired <span class="arrow">▼</span>
                    </button>
                    <div class="dropdown-menu">
                        {% for subject in retired_subjects %}
                        <a href="{{ url_for('display_subject', subject_name=subject) }}" class="dropdown-item">{{
                            subject }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <a href="{{ url_for('stats') }}" class="nav-link">Stats</a>
                <a href="{{ url_for('about') }}" class="nav-link">About</a>
            </div>
            <div class="nav-actions">
                <label class="switch icon-switch scheme-switch nav-switch" title="Toggle Color Scheme (Frosty/Toasty)">
                    <input type="checkbox" id="scheme-toggle">
                    <span class="slider"></span>
                </label>
                <label class="switch icon-switch theme-switch nav-switch" title="Toggle Dark Mode">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
                <a href="{{ url_for('logout') }}" class="nav-link logout-link">Log Out</a>
            </div>
        </nav>

        <div class="content-container">
            <div class="toast-container">{% with messages = get_flashed_messages(with_categories=true) %}{% if messages
                %}{% for c, m in messages %}<div class="toast {{ c }} show">{{ m }}</div>{% endfor %}{% endif %}{%
                endwith %}</div>




            <div class="main-container">
                <div class="full-width-panel">

                    <div class="action-bar animate-enter">
                        <!-- Hidden form for compatibility with existing JS that might look for these inputs -->
                        <form id="filter-form" style="display:none;">
                            <input type="hidden" name="subject" id="subject-filter" value="{{ selected_subject }}">
                            <input type="hidden" name="category" id="category-filter" value="{{ selected_category }}">
                        </form>

                        {% if selected_subject and selected_subject != 'all' %}
                        {% if subject_categories_map_py[selected_subject] %}
                        <div class="category-filter-container">
                            <label for="category-filter-visible">Category:</label>
                            <select id="category-filter-visible"
                                onchange="window.location.href='?category=' + this.value">
                                <option value="all">All Categories</option>
                                {% for category in subject_categories_map_py[selected_subject] %}
                                <option value="{{ category }}" {% if category==selected_category %}selected{% endif %}>
                                    {{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="category-filter-container">
                            <label for="subject-filter-visible">Subject:</label>
                            <select id="subject-filter-visible">
                                <option value="all">All Subjects</option>
                                {% for subject in subjects %}
                                <option value="{{ subject }}" {% if subject==selected_subject %}selected{% endif %}>
                                    {{ subject }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="action-buttons">
                            <button id="show-predictions-btn" class="grade-lock-btn lock-off"
                                style="margin-right: 10px;">
                                Show Predictions: OFF
                            </button>
                            <button id="grade-lock-btn" class="grade-lock-btn lock-off">
                                Grade Lock: OFF
                            </button>
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;" class="animate-enter delay-1">Assessments</h2>
                    <div class="table-wrapper animate-enter delay-2">
                        <table>
                            <thead>
                                <tr>
                                    {% if is_dashboard %}
                                    <th style="white-space:nowrap; width: 30px;">
                                        <span class="drag-col-hint" title="Drag rows">⇅</span>
                                    </th>
                                    {% else %}
                                    <th style="white-space:nowrap; width: 56px;">
                                        <span class="drag-col-hint" title="Drag rows">⇅</span>
                                        <input type="checkbox" id="selectAll">
                                    </th>
                                    {% endif %}
                                    <th>Subject</th>
                                    <th>Category</th>
                                    <th>Study Time</th>
                                    <th>Assessment Name</th>
                                    <th>Grade</th>
                                    <th>Weight</th>
                                    {% if not is_dashboard %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                                {% if summary_data %}
                                <tr class="summary-row">
                                    <td></td>
                                    <td><strong>Summary for {{ selected_subject }}</strong></td>
                                    <td>-</td>
                                    <td>{{ "%.1f"|format(summary_data.total_hours) }}h (total)</td>
                                    <td>-</td>
                                    <td>{{ "%.1f"|format(summary_data.average_grade) }}% (avg)</td>
                                    <td>{{ "%.2f"|format(summary_data.total_weight) }}% (graded)</td>
                                    {% if not is_dashboard %}
                                    <td>-</td>
                                    {% endif %}
                                </tr>
                                {% endif %}
                            </thead>

                            <tbody id="study-table-body">
                                {% for row in data %}
                                <tr data-id="{{ row.id }}"
                                    class="assignment-row {% if row.is_prediction %}prediction-row{% endif %}">
                                    {% if is_dashboard %}
                                    <td>
                                        <span class="drag-handle" title="Drag" aria-label="Drag to reorder">⋮⋮</span>
                                    </td>
                                    {% else %}
                                    <td>
                                        <span class="drag-handle" title="Drag" aria-label="Drag to reorder">⋮⋮</span>
                                        <input type="checkbox" class="select-assignment" data-id="{{ row.id }}">
                                    </td>
                                    {% endif %}
                                    <td>{{ row.subject }}</td>
                                    <td><span class="category-tag"><svg xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path
                                                    d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z">
                                                </path>
                                                <line x1="7" y1="7" x2="7.01" y2="7"></line>
                                            </svg> {{ row.category }}</span></td>
                                    {% if row.is_prediction %}
                                    <td><input type="number" name="study_time" class="prediction-input hours-input"
                                            data-id="{{ row.id }}" value="{{ row.study_time }}" step="0.1" min="0"
                                            style="width: 80px;"> hours
                                    </td>
                                    <td class="prediction-name-cell" contenteditable="true" data-id="{{ row.id }}">{{
                                        row.assignment_name }}</td>
                                    <td><input type="number" name="grade" class="prediction-input grade-input"
                                            data-id="{{ row.id }}" value="{{ row.grade }}" step="1" min="0"
                                            style="width: 80px;">%</td>
                                    {% else %}
                                    <td>{{ "%.1f"|format(row.study_time) }} hours</td>
                                    <td>{{ row.assignment_name }}</td>
                                    <td>{% if row.grade is not none %}{{ row.grade }}%{% else %}-{% endif %}</td>
                                    {% endif %}
                                    <td>{{ "%.2f"|format(row.weight) }}%</td>
                                    {% if not is_dashboard %}
                                    <td>
                                        {% if row.is_prediction %}
                                        <button class="action-btn predict-btn">Predict</button>
                                        <button class="action-btn add-prediction-btn">Add</button>
                                        <button class="action-btn delete-btn">Delete</button>
                                        {% else %}
                                        <button class="action-btn edit-btn">Edit</button>
                                        <button class="action-btn delete-btn">Delete</button>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                </tr>{% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- Combined Control Bar -->
                    <div class="control-bar animate-enter delay-3"
                        style="display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 20px; align-items: center; margin-top: 15px; padding: 15px; background-color: var(--surface-color); border: 1px solid var(--border-light); border-radius: 8px; box-shadow: var(--shadow);">

                        <!-- Standard Buttons -->
                        <div class="button-group" style="display: flex; gap: 8px;">
                            {% if selected_subject and selected_subject != 'all' %}
                            <button id="addRowBtn"
                                style="padding: 8px 12px; font-size: 0.85em; white-space: nowrap;">Add
                                Assessment</button>
                            <button id="addPredictionBtn"
                                style="padding: 8px 12px; font-size: 0.85em; background-color: var(--accent-color); white-space: nowrap;">Add
                                Prediction</button>
                            {% endif %}
                            <button id="deleteSelectedBtn"
                                style="display:none; padding: 8px 12px; font-size: 0.85em; white-space: nowrap;">Delete
                                Selected (<span id="selectedCount">0</span>)</button>
                            <button id="deselectAllBtn"
                                style="display:none; padding: 8px 12px; font-size: 0.85em; white-space: nowrap;">Deselect
                                All</button>
                        </div>

                        <!-- Subject Grade Predictor (Conditional) -->
                        <div id="subject-predictor-container"
                            style="display: none; flex: 1; min-width: 300px; border-left: 2px solid var(--border-light); padding-left: 20px;">
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <h3 style="margin: 0; font-size: 1.1em; white-space: nowrap; color: var(--text-color);">
                                    Subject Predictor:</h3>

                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="position: relative;">
                                        <input type="number" id="predict-overall-grade" placeholder="Target Grade"
                                            step="0.1" min="0" style="width: 140px; padding: 8px; padding-right: 25px;">
                                        <span
                                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.8em;">%</span>
                                    </div>
                                    <span style="color: var(--text-secondary); font-weight: bold;">OR</span>
                                    <div style="position: relative;">
                                        <input type="number" id="predict-study-time" placeholder="Add. Time" step="0.1"
                                            min="0" style="width: 140px; padding: 8px; padding-right: 45px;">
                                        <span
                                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.8em;">hours</span>
                                    </div>
                                </div>

                                <button id="trigger-subject-predict-btn"
                                    style="padding: 8px 12px; font-size: 0.85em; background-color: var(--primary-color); color: white; white-space: nowrap;">Predict</button>

                                <div
                                    style="display: flex; gap: 20px; align-items: center; margin-left: auto; font-size: 0.95em;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.8em; color: var(--text-secondary);">Remaining Weight
                                        </div>
                                        <div id="predictor-remaining-weight"
                                            style="font-weight: bold; font-size: 1.1em;">-</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.8em; color: var(--text-secondary);">Avg Needed</div>
                                        <div id="predictor-avg-needed" style="font-weight: bold; font-size: 1.1em;">-
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if selected_subject and selected_subject != 'all' %}
                <div class="category-section animate-enter delay-4" style="margin-top: 30px;">
                    <h2>Grading Scheme Categories for {{ selected_subject }}</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Category Name</th>
                                <th>Total Weight (%)</th>
                                <th># Assessments</th>
                                <th>Calculated Weight</th>
                                <th>Default Name Pattern</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="category-table-body">
                            {% for cat in weight_categories_py.get(selected_subject, []) %}
                            <tr data-id="{{ cat.id }}" data-name="{{ cat.name }}">
                                <td>{{ cat.name }}</td>
                                <td>{{ cat.total_weight }}%</td>
                                <td class="num-assessments">{{ cat.num_assessments }}</td>
                                <td class="calculated-weight">{% if cat.num_assessments > 0 %}{{
                                    "%.2f"|format(cat.total_weight / cat.num_assessments) }}%{% else %}N/A{% endif
                                    %}
                                </td>
                                <td>{{ cat.default_name if cat.default_name else '-' }}</td>
                                <td><button class="action-btn edit-btn">Edit</button><button
                                        class="action-btn delete-btn">Delete</button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="total-weight-indicator"
                        style="margin-top: 1em; padding: 10px; border-radius: 4px; font-weight: bold;">
                        Total Weight: <span id="total-weight-value">0</span>% / 100%
                    </div>
                    <button id="addCategoryBtn" style="margin-top: 1em;">Add Grading Scheme Category</button>
                </div>
                {% endif %}
            </div>

        </div>

        {% if selected_subject and selected_subject != 'all' %}
        <div class="subject-actions-bar animate-enter delay-5"
            style="margin-top: 40px; margin-bottom: 40px; padding-top: 20px; border-top: 2px solid var(--border-light); width: 100%; text-align: center;">
            {% if is_retired_subject %}
            <button type="button" id="restore-subject-btn" class="subject-action-btn"
                style="padding: 10px 20px; font-size: 1em; background-color: var(--success-color); color: white; margin-right: 15px;"
                data-subject="{{ selected_subject }}">
                Restore Subject {{ selected_subject }}
            </button>
            {% else %}
            <button type="button" id="retire-subject-btn" class="subject-action-btn"
                style="padding: 10px 20px; font-size: 1em; background-color: var(--text-secondary); color: white; margin-right: 15px;"
                data-subject="{{ selected_subject }}">
                Retire Subject {{ selected_subject }}
            </button>
            {% endif %}
            <button type="button" id="delete-subject-btn" class="subject-action-btn delete-subject-btn"
                style="padding: 10px 20px; font-size: 1em;" data-subject="{{ selected_subject }}">Delete Subject {{
                selected_subject }}</button>
        </div>
        {% endif %}
    </div>
    </div>


    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-confirm-yes">Yes, Delete</button>
                <button id="modal-confirm-no">No, Cancel</button>
            </div>
        </div>
    </div>

    <div id="add-subject-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0;">Add New Subject</h3>
            <input type="text" id="new-subject-input" placeholder="Enter subject name..."
                style="width: 100%; padding: 10px; margin-bottom: 1em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
            <div class="modal-buttons">
                <button id="subject-modal-confirm">Add Subject</button>
                <button id="subject-modal-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <div id="delete-subject-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0; color: #dc3545;">Delete Subject</h3>
            <p id="delete-subject-message"></p>
            <div class="modal-buttons">
                <button id="delete-subject-confirm" style="background-color: #dc3545;">Continue</button>
                <button id="delete-subject-cancel" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="delete-subject-final-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0; color: #dc3545;">⚠️ FINAL WARNING</h3>
            <p id="delete-subject-final-message"></p>
            <div class="modal-buttons">
                <button id="delete-subject-final-confirm" style="background-color: #dc3545; font-weight: bold;">Yes,
                    Delete Forever</button>
                <button id="delete-subject-final-cancel" style="background-color: #6c757d;">No, Cancel</button>
            </div>
        </div>
    </div>

    <div id="rename-subject-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0;">Rename Subject</h3>
            <input type="text" id="rename-subject-input" placeholder="Enter new subject name..."
                style="width: 100%; padding: 10px; margin-bottom: 1em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
            <div class="modal-buttons">
                <button id="rename-subject-confirm"
                    style="background-color: var(--primary-color); color: white;">Rename</button>
                <button id="rename-subject-cancel"
                    style="background-color: var(--text-secondary); color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="retire-subject-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0; color: var(--text-secondary);">Retire Subject</h3>
            <p id="retire-subject-message"></p>
            <div class="modal-buttons">
                <button id="retire-subject-confirm" style="background-color: var(--text-secondary); color: white;">Yes,
                    Retire</button>
                <button id="retire-subject-cancel" style="background-color: #6c757d; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="restore-subject-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0; color: var(--success-color);">Restore Subject</h3>
            <p id="restore-subject-message"></p>
            <div class="modal-buttons">
                <button id="restore-subject-confirm" style="background-color: var(--success-color); color: white;">Yes,
                    Restore</button>
                <button id="restore-subject-cancel" style="background-color: #6c757d; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="update-naming-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0; color: var(--primary-color);">Update Assignment Names?</h3>
            <p id="update-naming-message">You've changed the naming scheme. Would you like to update all existing
                assignment names in this category to match the new pattern?</p>
            <p id="update-naming-example" style="font-style: italic; color: var(--text-secondary);"></p>
            <div class="modal-buttons">
                <button id="update-naming-yes" style="background-color: var(--primary-color); color: white;">Yes, Update
                    Names</button>
                <button id="update-naming-no" style="background-color: #6c757d; color: white;">No, Keep Old
                    Names</button>
            </div>
        </div>
    </div>
    </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}?v={{ range(1, 10000) | random }}" defer></script>
    <!-- <script src="{{ url_for('static', filename='js/menu-fix.js') }}?v={{ range(1, 10000) | random }}" defer></script> -->
</body>

</html>